

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Wavelength recalibration with the sky lines (Mendel OH bands) &mdash; Orcs 2.2.2 documentation</title>
  

  
  
    <link rel="shortcut icon" href="_static/logo.ico"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Orcs 2.2.2 documentation" href="index.html"/>
        <link rel="up" title="Examples" href="examples.html"/>
        <link rel="next" title="Image registration" href="script_example_image_registration.html"/>
        <link rel="prev" title="Modelling and fitting two unresolved emission lines with a bayesian approach" href="script_example_model+fit_2_lines_bayes.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Orcs
          

          
            
            <img src="_static/logo_sidebar.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                2.2.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="examples.html#first-basic-examples">First basic examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#bayesian-fitting-vs-classical-fitting">Bayesian fitting vs. classical fitting</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="examples.html#calibrating-your-data">Calibrating your data</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Wavelength recalibration with the sky lines (Mendel OH bands)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#First-step:-checking-the-calibration">First step: checking the calibration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Second-step:-Mapping-the-sky-velocity">Second step: Mapping the sky velocity</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Resulting-data">Resulting data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Calibrating-your-data-with-the-sky-velocity-map">Calibrating your data with the sky velocity map</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="script_example_image_registration.html">Image registration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#advanced-fitting">Advanced fitting</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#other-tools">Other Tools</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="core_module.html">Core module</a></li>
<li class="toctree-l1"><a class="reference internal" href="process_module.html">Process module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rvcorrect_module.html">RVCorrect module</a></li>
<li class="toctree-l1"><a class="reference internal" href="utils_module.html">Utils module</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="known_issues.html">Known Issues</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Orcs</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="examples.html">Examples</a> &raquo;</li>
        
      <li>Wavelength recalibration with the sky lines (Mendel OH bands)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/script_example_wavelength_calibration.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-bold { font-weight: bold; }

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

/* nice headers on first paragraph of info/warning boxes */
.admonition .first {
    margin: -12px;
    padding: 6px 12px;
    margin-bottom: 12px;
    color: #fff;
    line-height: 1;
    display: block;
}
.admonition.warning .first {
    background: #f0b37e;
}
.admonition.note .first {
    background: #6ab0de;
}
.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="Wavelength-recalibration-with-the-sky-lines-(Mendel-OH-bands)">
<h1>Wavelength recalibration with the sky lines (Mendel OH bands)<a class="headerlink" href="#Wavelength-recalibration-with-the-sky-lines-(Mendel-OH-bands)" title="Permalink to this headline">¶</a></h1>
<div class="section" id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Permalink to this headline">¶</a></h2>
<p>Data can be recalibrated in wavelength easily when one OH sky lines are
visible in most parts of the field of view. Cubes observed in the red
part of the spectrum (e.g. SN3 filter) are especially interesting in
this respect.</p>
<p>The general idea is to extract integrated spectra at different positions
in the field of view and measure the velocity of the sky lines (which
should be 0 if the calibration was perfect) (see <a class="reference external" href="https://arxiv.org/abs/1707.01366">Martin et al.
2017a</a>).</p>
<div class="figure" id="id1">
<img alt="skymap-fig0.svg" src="_images/skymap-fig0.svg" /><p class="caption"><span class="caption-text">skymap-fig0.svg</span></p>
</div>
<p>Then the correction map can be infered at each pixel by fitting a model.</p>
<div class="figure" id="id2">
<img alt="skymap-fig1.svg" src="_images/skymap-fig1.svg" /><p class="caption"><span class="caption-text">skymap-fig1.svg</span></p>
</div>
<p>The calibration model is based on a simple modeling of the
interferometer.</p>
<div class="figure" id="id3">
<img alt="coords0.svg" src="_images/coords0.svg" /><p class="caption"><span class="caption-text">coords0.svg</span></p>
</div>
</div>
<div class="section" id="First-step:-checking-the-calibration">
<h2>First step: checking the calibration<a class="headerlink" href="#First-step:-checking-the-calibration" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="c1"># inline plotting for jupyter notebook. Do not put this line in a real python script.</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="c1"># import base class for the manipulation of a SITELLE spectral cube: HDFCube</span>
<span class="kn">from</span> <span class="nn">orcs.process</span> <span class="kn">import</span> <span class="n">SpectralCube</span>
<span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">pl</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="c1"># load spectral cube</span>
<span class="n">cube</span> <span class="o">=</span> <span class="n">SpectralCube</span><span class="p">(</span><span class="s1">&#39;/home/thomas/M31_SN3.merged.cm1.1.0.hdf5&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
INFO&gt; Data shape : (2048, 2064, 840)
INFO&gt; Cube is in WAVENUMBER (cm-1)
INFO&gt; Cube is CALIBRATED
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="c1"># extract and plot a spectrum of a large integrated region. The sky lines should appear.</span>
<span class="n">axis</span><span class="p">,</span> <span class="n">spectrum</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">extract_spectrum</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">14500</span><span class="p">,</span> <span class="mi">15500</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
INFO&gt; Number of integrated pixels: 1257
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
 [==========] [100%] [completed in 0.429 s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[4]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>(14500, 15500)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/script_example_wavelength_calibration_5_3.png" src="_images/script_example_wavelength_calibration_5_3.png" />
</div>
</div>
<div class="section" id="fitting-the-sky-spectrum">
<h3>fitting the sky spectrum<a class="headerlink" href="#fitting-the-sky-spectrum" title="Permalink to this headline">¶</a></h3>
<p>we can also fit the integrated spectrum because there si a large number
of sky lines and because we are not interested in a perfect fit (only
the velocity is required), we can use a simple &#8216;sinc&#8217; model with a fixed
fwhm. All the lines are set to share the same velocity parameter and we
set an inital guess of the velocity around 80 km/s. This general bias of
80 km/s is known (<a class="reference external" href="https://arxiv.org/abs/1706.03230">Martin et al.
2017b</a>) and comes from the error
made on the real wavelength of the calibration laser (which is falsely
considered to be at 453.5 nm).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">sky_lines_cm1</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">get_sky_lines</span><span class="p">()</span>
<span class="n">axis</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">fit_res</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">fit_lines_in_spectrum</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">sky_lines_cm1</span><span class="p">,</span>
                                                     <span class="n">fmodel</span><span class="o">=</span><span class="s1">&#39;sinc&#39;</span><span class="p">,</span>
                                                     <span class="n">pos_def</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
                                                     <span class="n">fwhm_def</span><span class="o">=</span><span class="s1">&#39;fixed&#39;</span><span class="p">,</span>
                                                     <span class="n">nofilter</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                                     <span class="n">pos_cov</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
<span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">===== Results ======&#39;</span>
<span class="k">print</span> <span class="s1">&#39;Velocity: &#39;</span><span class="p">,</span> <span class="n">fit_res</span><span class="p">[</span><span class="s1">&#39;velocity_gvar&#39;</span><span class="p">]</span>
<span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">fit_res</span><span class="p">[</span><span class="s1">&#39;fitted_vector&#39;</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">14500</span><span class="p">,</span> <span class="mi">15500</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
INFO&gt; Number of integrated pixels: 1257
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
 [==========] [100%] [completed in 0.033 s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-yellow-fg">WARNING&gt; /home/thomas/Astro/Python/ORB/Orcs/orcs/core.py:1679: RuntimeWarning: invalid value encountered in sqrt
  noise_counts = np.sqrt(total_counts)
</span>
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

===== Results ======
Velocity:  [72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5)
 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5)
 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5)
 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5)
 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5)
 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5)
 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5)
 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5)
 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5)
 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5)
 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5)
 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5)
 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5) 72.1(1.5)
 72.1(1.5) 72.1(1.5)]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[5]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>(14500, 15500)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/script_example_wavelength_calibration_7_5.png" src="_images/script_example_wavelength_calibration_7_5.png" />
</div>
</div>
</div>
</div>
<div class="section" id="Second-step:-Mapping-the-sky-velocity">
<h2>Second step: Mapping the sky velocity<a class="headerlink" href="#Second-step:-Mapping-the-sky-velocity" title="Permalink to this headline">¶</a></h2>
<p>Warning: this process can take a long time because a spectrum is
extracted and fitted for each point of a 40x40 grid by default. For a
basic example it is recommended to limit the number of grid division to
10x10.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="n">cube</span><span class="o">.</span><span class="n">map_sky_velocity</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="n">div_nb</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># the mean velocity bias is set around 80 km/s</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
17-07-24|18:24:57 # SpectralCube.map_sky_velocity &gt; fitting process already done. Do you really want to redo it again ?
type [yes]: no
<span class="ansi-yellow-fg">17-07-24|18:25:00 # SpectralCube.map_sky_velocity &gt; Warning: Fitting process not done again, only the final sky map is computed</span>
<span class="ansi-yellow-fg">17-07-24|18:25:00 # Lines._custom_warn &gt; Warning: /home/thomas/Astro/Python/ORB/Orcs/orcs/process.py:304: RuntimeWarning: invalid value encountered in greater
  sky_vel_map[sky_vel_map &gt; np.nanpercentile(sky_vel_map, 95)] = np.nan
</span>
First laser wavelentgh calibration estimation: 543.356235946 nm
Angle at the center of the frame: 15.4977038652
<span class="ansi-yellow-fg">17-07-24|18:25:00 # Lines._custom_warn &gt; Warning: /home/thomas/Astro/Python/ORB/Orb/orb/utils/image.py:1038: RuntimeWarning: invalid value encountered in less
  calib_laser_map[np.nonzero(calib_laser_map &lt; value_min)] = np.nan
</span>
&gt; Binning calibration map
&gt; Calibration laser map fit
  &gt; First fit on the central portion of the calibration laser map (30.0% of the total size)
    &gt; Calibration laser map fit parameters:
    distance to mirror: 23.6954632448 cm
    X angle from the optical axis to the center: 0.0 degrees (Fixed)
    Y angle from the optical axis to the center: 15.5050669216 degrees
    Tip-tilt angle of the detector along X: 0.0 degrees (Fixed)
    Tip-tilt angle of the detector along Y: 0.0 degrees (Fixed)
    Rotation angle of the detector: 0.0 degrees (Fixed)
    Calibration laser wavelength: 543.356235946 nm (Fixed)
    Error on fit: mean -1.16831223579e-06, std 0.0515054158154 (in nm)
    Error on fit: mean -0.000645053185275, std 28.437374456 (in km/s)
  &gt; Second fit on the central portion of the calibration laser map (30.0% of the total size)
    &gt; Calibration laser map fit parameters:
    distance to mirror: 23.6792529911 cm
    X angle from the optical axis to the center: -0.467393834246 degrees
    Y angle from the optical axis to the center: 15.4980058922 degrees
    Tip-tilt angle of the detector along X: 0.427357564651 degrees
    Tip-tilt angle of the detector along Y: -1.24571403707 degrees
    Rotation angle of the detector: 0.0 degrees (Fixed)
    Calibration laser wavelength: 543.356235946 nm (Fixed)
    Error on fit: mean -3.94460707057e-07, std 0.000791471197978 (in nm)
    Error on fit: mean -0.000217791210054, std 0.436990216888 (in km/s)
  &gt; Third fit on a larger portion of the map (50.0% of the total size)
    &gt; Calibration laser map fit parameters:
    distance to mirror: 23.7163902827 cm
    X angle from the optical axis to the center: -0.467753337786 degrees
    Y angle from the optical axis to the center: 15.498384909 degrees
    Tip-tilt angle of the detector along X: 0.311296394954 degrees
    Tip-tilt angle of the detector along Y: -0.724167834406 degrees
    Rotation angle of the detector: 0.0 degrees (Fixed)
    Calibration laser wavelength: 543.356235946 nm (Fixed)
    Error on fit: mean -2.73378866828e-06, std 0.00312555663736 (in nm)
    Error on fit: mean -0.00150939024203, std 1.72569472691 (in km/s)
  &gt; Zernike polynomials fit of the residual wavefront
<span class="ansi-yellow-fg">17-07-24|18:25:03 # Lines._custom_warn &gt; Warning: /home/thomas/Astro/Python/ORB/Orb/orb/ext/zern.py:54: DeprecationWarning: object of type &lt;type &#39;float&#39;&gt; cannot be safely interpreted as an integer.
  r0v = np.linspace(-1-center[0], 1-center[0], r0).astype(dtype).reshape(-1,1)
</span>
<span class="ansi-yellow-fg">17-07-24|18:25:03 # Lines._custom_warn &gt; Warning: /home/thomas/Astro/Python/ORB/Orb/orb/ext/zern.py:55: DeprecationWarning: object of type &lt;type &#39;float&#39;&gt; cannot be safely interpreted as an integer.
  r1v = np.linspace(-1-center[1], 1-center[1], r1).astype(dtype).reshape(1,-1)
</span>
Standard deviation of the residual: 1.84989027732e-05
Median relative error (err/val)): 0.05%
&gt; final error (std on 50.0% of the total size): 1.764e-05 nm, 9.739e-03 km/s
    &gt; New calibration laser map fit parameters:
    distance to mirror: 23.7195966921 cm
    X angle from the optical axis to the center: 0.0365916904474 degrees
    Y angle from the optical axis to the center: 15.5142349306 degrees
    Tip-tilt angle of the detector along X: 1.19648939214 degrees
    Tip-tilt angle of the detector along Y: 0.126632246957 degrees
    Rotation angle of the detector: 1.90131404301 degrees
    Calibration laser wavelength: 543.338776628 nm

fit residual std (in km/s): 1.66892593866
median error on the data (in km/s) 1.41094439599
Data written as M31_SN3.1.0.ORCS/M31_SN3.1.0.calibration_laser_map.fits in 0.36 s
Data written as M31_SN3.1.0.ORCS/M31_SN3.1.0.wavefront_map.fits in 0.19 s
Data written as M31_SN3.1.0.ORCS/M31_SN3.1.0.skymap.fits in 0.19 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/script_example_wavelength_calibration_9_1.png" src="_images/script_example_wavelength_calibration_9_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/script_example_wavelength_calibration_9_2.png" src="_images/script_example_wavelength_calibration_9_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/script_example_wavelength_calibration_9_3.png" src="_images/script_example_wavelength_calibration_9_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/script_example_wavelength_calibration_9_4.png" src="_images/script_example_wavelength_calibration_9_4.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/script_example_wavelength_calibration_9_5.png" src="_images/script_example_wavelength_calibration_9_5.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/script_example_wavelength_calibration_9_6.png" src="_images/script_example_wavelength_calibration_9_6.png" />
</div>
</div>
</div>
<div class="section" id="Resulting-data">
<h2>Resulting data<a class="headerlink" href="#Resulting-data" title="Permalink to this headline">¶</a></h2>
<p>The most important result is the skymap which gives the modelized
velocity of the sky in the field of view and permit to correct the
measured velocities in the cube.This map is named <code class="docutils literal"><span class="pre">*skymap.fits</span></code>.</p>
<p>In this particular case this is
<code class="docutils literal"><span class="pre">M31_SN3.1.0.ORCS/M31_SN3.1.0.skymap.fits</span></code></p>
<p>The histogram displays the difference between the measured velocity and
the fitted velocity at each valid data point.</p>
<p>You can see by looking at the other maps that in the cas of M31 there
are some data points at the center of the field which could not give a
valid velocity of the sky. This comes from the fact that M31 is very
bright at the center and the sky lines are lost in the noise produced by
the high continuum background. Modelling the interferometer makes
possible to estimate the velocity of the lines at the center of the
field where no real data has been obtained. And the result is stricking,
it works particularly well even if the case of M31 (<a class="reference external" href="https://arxiv.org/abs/1707.01366">Martin et al.
2017a</a>)</p>
</div>
<div class="section" id="Calibrating-your-data-with-the-sky-velocity-map">
<h2>Calibrating your data with the sky velocity map<a class="headerlink" href="#Calibrating-your-data-with-the-sky-velocity-map" title="Permalink to this headline">¶</a></h2>
<p>Once the velocity map is passed to the SpectralCube class, the class
will internaly make the appropriate corrections so that the measured
velocity of any spectrum will be corrected. But it will also correct the
spectral misalignment of the spectra before extracting the data which
should have an effect on the broadening of the lines when a spectrum is
integrated over a large field of view with a non-negligible gradient on
the velocity calibration.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="c1"># the computed sky velocity map is passed to cube</span>
<span class="n">cube</span><span class="o">.</span><span class="n">correct_wavelength</span><span class="p">(</span><span class="s1">&#39;M31_SN3.1.0.ORCS/M31_SN3.1.0.skymap.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span><span class="c1"># The same sky spectrum is now extracted and fitted and the measured velocity is now similar to 0 km/s.</span>
<span class="c1"># Note that the calibration map used here has not been calculated with a 40x40 grid. The calibration</span>
<span class="c1"># quality would have been better in this case.</span>

<span class="n">sky_lines_cm1</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">get_sky_lines</span><span class="p">()</span>
<span class="n">axis</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">fit_res</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">fit_lines_in_spectrum</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">sky_lines_cm1</span><span class="p">,</span>
                                                     <span class="n">fmodel</span><span class="o">=</span><span class="s1">&#39;sinc&#39;</span><span class="p">,</span>
                                                     <span class="n">pos_def</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
                                                     <span class="n">fwhm_def</span><span class="o">=</span><span class="s1">&#39;fixed&#39;</span><span class="p">,</span>
                                                     <span class="n">nofilter</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                                     <span class="n">pos_cov</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
<span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">===== Results ======&#39;</span>
<span class="k">print</span> <span class="s1">&#39;Velocity: &#39;</span><span class="p">,</span> <span class="n">fit_res</span><span class="p">[</span><span class="s1">&#39;velocity_gvar&#39;</span><span class="p">]</span>
<span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">fit_res</span><span class="p">[</span><span class="s1">&#39;fitted_vector&#39;</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">14500</span><span class="p">,</span> <span class="mi">15500</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
17-07-25|09:28:24 # SpectralCube._extract_spectrum_from_region &gt; Number of integrated pixels: 1257
 [==========] [100%] [completed in 0.030 s]
Init of the parallel processing server with 4 threads
 [==========] [100%] [completed in 0.734 s]
SNR GUESS None

===== Results ======
Velocity:  [-3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1)
 -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1)
 -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1)
 -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1)
 -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1)
 -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1)
 -3.2(1.1) -3.2(1.1) -3.2(1.1) -3.2(1.1)]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[6]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>(14500, 15500)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/script_example_wavelength_calibration_13_2.png" src="_images/script_example_wavelength_calibration_13_2.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="script_example_image_registration.html" class="btn btn-neutral float-right" title="Image registration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="script_example_model+fit_2_lines_bayes.html" class="btn btn-neutral" title="Modelling and fitting two unresolved emission lines with a bayesian approach" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Thomas Martin (thomas.martin.1@ulaval.ca).

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'2.2.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>