

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Wavelength recalibration with the sky lines (Mendel OH bands) &mdash; Orcs latest documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="_static/logo.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Image registration" href="script_example_image_registration.html" />
    <link rel="prev" title="Modelling and fitting two unresolved emission lines with a bayesian approach" href="script_example_model%2Bfit_2_lines_bayes.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Orcs
          

          
            
            <img src="_static/logo_sidebar.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                lastest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="examples.html#first-basic-examples">First basic examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#automatic-velocity-and-flux-estimation-complete-examples">Automatic velocity and flux estimation (complete examples)</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#bayesian-fitting-vs-classical-fitting">Bayesian fitting vs. classical fitting</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="examples.html#calibrating-your-data">Calibrating your data</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Wavelength recalibration with the sky lines (Mendel OH bands)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#First-step:-checking-the-calibration">First step: checking the calibration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Second-step:-Mapping-the-sky-velocity">Second step: Mapping the sky velocity</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Ouputs">Ouputs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="script_example_image_registration.html">Image registration</a></li>
<li class="toctree-l3"><a class="reference internal" href="script_example_hst_flux_calibration.html">Flux Calibration Example Using HST image</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#advanced-fitting">Advanced fitting</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#other-tools">Other Tools</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="core_module.html">Core module</a></li>
<li class="toctree-l1"><a class="reference internal" href="fit_module.html">Fit module</a></li>
<li class="toctree-l1"><a class="reference internal" href="process_module.html">Process module</a></li>
<li class="toctree-l1"><a class="reference internal" href="utils_module.html">Utils module</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Orcs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="examples.html">Examples</a> &raquo;</li>
        
      <li>Wavelength recalibration with the sky lines (Mendel OH bands)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/script_example_wavelength_calibration.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Wavelength-recalibration-with-the-sky-lines-(Mendel-OH-bands)">
<h1>Wavelength recalibration with the sky lines (Mendel OH bands)<a class="headerlink" href="#Wavelength-recalibration-with-the-sky-lines-(Mendel-OH-bands)" title="Permalink to this headline">¶</a></h1>
<div class="section" id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Permalink to this headline">¶</a></h2>
<p>Data can be recalibrated in wavelength easily when one OH sky lines are visible in most parts of the field of view. Cubes observed in the red part of the spectrum (e.g. SN3 filter) are especially interesting in this respect.</p>
<p>The general idea is to extract integrated spectra at different positions in the field of view and measure the velocity of the sky lines (which should be 0 if the calibration was perfect) (see <a class="reference external" href="https://arxiv.org/abs/1707.01366">Martin et al. 2017a</a>).</p>
<p><img alt="skymap-fig0.svg" src="_images/skymap-fig0.svg" /></p>
<p>Then the correction map can be infered at each pixel by fitting a model.</p>
<p><img alt="skymap-fig1.svg" src="_images/skymap-fig1.svg" /></p>
<p>The calibration model is based on a simple modeling of the interferometer.</p>
<p><img alt="coords0.svg" src="_images/coords0.svg" /></p>
</div>
<div class="section" id="First-step:-checking-the-calibration">
<h2>First step: checking the calibration<a class="headerlink" href="#First-step:-checking-the-calibration" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span># import base class for the manipulation of a SITELLE spectral cube: HDFCube
from orcs.process import SpectralCube
import pylab as pl
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span># load spectral cube
cube = SpectralCube(&#39;/home/thomas/M31_SN3.merged.cm1.1.0.hdf5&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
master.fa09a|INFO| Cube is level 3
master.fa09a|INFO| shape: (2048, 2064, 840)
master.fa09a|INFO| wavenumber calibration: True
master.fa09a|INFO| flux calibration: True
master.fa09a|INFO| wcs calibration: True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span># extract and plot a spectrum of a large integrated region. Sky lines should be visible.
spectrum = cube.get_spectrum(50, 50, 20)
pl.figure(figsize=(10,6))
spectrum.plot()
pl.xlim(14500, 15500)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(14500, 15500)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/script_example_wavelength_calibration_4_1.png" src="_images/script_example_wavelength_calibration_4_1.png" />
</div>
</div>
<div class="section" id="fitting-the-sky-spectrum">
<h3>fitting the sky spectrum<a class="headerlink" href="#fitting-the-sky-spectrum" title="Permalink to this headline">¶</a></h3>
<p>we can also fit the integrated spectrum because there si a large number of sky lines and because we are not interested in a perfect fit (only the velocity is required), we can use a simple ‘sinc’ model with a fixed fwhm. All the lines are set to share the same velocity parameter and we set an inital guess of the velocity around 80 km/s. This general bias of 80 km/s is known (<a class="reference external" href="https://arxiv.org/abs/1706.03230">Martin et al. 2017b</a>) and comes from the error made on the real wavelength of the
calibration laser (which is falsely considered to be at 453.5 nm).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>sky_lines_cm1 = cube.get_sky_lines()
fit_res = spectrum.fit(sky_lines_cm1,
                       fmodel=&#39;sinc&#39;,
                       pos_def=&#39;1&#39;,
                       fwhm_def=&#39;fixed&#39;,
                       nofilter=False,
                       pos_cov=80)

print(&#39;Velocity: &#39;, fit_res[&#39;velocity_gvar&#39;][0])
pl.figure(figsize=(10,6))
spectrum.plot()
fit_res.get_spectrum().plot(c=&#39;red&#39;)
pl.xlim(14500, 15500)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Velocity:  77.5(1.5)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(14500, 15500)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/script_example_wavelength_calibration_6_2.png" src="_images/script_example_wavelength_calibration_6_2.png" />
</div>
</div>
</div>
</div>
<div class="section" id="Second-step:-Mapping-the-sky-velocity">
<h2>Second step: Mapping the sky velocity<a class="headerlink" href="#Second-step:-Mapping-the-sky-velocity" title="Permalink to this headline">¶</a></h2>
<p>This process, like other parallel processes may work better if run from a python script with the command. The following script can be used:</p>
<p><a class="reference external" href="./run_map_sky_velocity.py">run_map_sky_velocity.py</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">orcs.process</span> <span class="kn">import</span> <span class="n">SpectralCube</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span> <span class="c1"># this is very important when running parallel processes</span>
    <span class="n">cube</span> <span class="o">=</span> <span class="n">SpectralCube</span><span class="p">(</span><span class="s1">&#39;/home/thomas/M31_SN3.merged.cm1.1.0.hdf5&#39;</span><span class="p">)</span>
    <span class="n">cube</span><span class="o">.</span><span class="n">map_sky_velocity</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="n">div_nb</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">exclude_reg_file_path</span><span class="o">=</span><span class="s1">&#39;m31_exclude.reg&#39;</span><span class="p">,</span> <span class="n">no_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># the mean velocity bias is set around 80 km/s</span>
</pre></div>
</div>
<p><strong>Warning</strong>: this process can take a long time because a spectrum is extracted and fitted for each point of a 40x40 grid by default. For a basic example it is recommended to limit the number of grid division to 10x10.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span># once the fit is done, you can see the results with the following
cube = SpectralCube(&#39;/home/thomas/M31_SN3.merged.cm1.1.0.hdf5&#39;) # it is always better to reload the data cube right before running a parallel process
cube.map_sky_velocity(80, div_nb=10, exclude_reg_file_path=&#39;m31_exclude.reg&#39;, no_fit=False) # the mean velocity bias is set around 80 km/s
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
master.fa09a|INFO| Cube is level 3
master.fa09a|INFO| shape: (2048, 2064, 840)
master.fa09a|INFO| wavenumber calibration: True
master.fa09a|INFO| flux calibration: True
master.fa09a|INFO| wcs calibration: True
<span class="ansi-yellow-fg">master.fa09a|WARNING| fitting process already done ! set no_fit=True if you do not want to redo it</span>
master.fa09a|INFO| X range: 0 2048, Y range: 0 2064
master.fa09a|INFO| Radius: 30
master.fa09a|INFO| excluding region from file m31_exclude.reg
master.fa09a|INFO| 58 regions to fit
master.fa09a|INFO| 88 sky lines to fit
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
 loading region: Shape : circle ( Number(1861.81818),Number(1876.36364),Number(30.00000) )

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
master.fa09a|INFO| reloading cube
master.fa09a|INFO| Cube is level 3
master.fa09a|INFO| shape: (2048, 2064, 840)
master.fa09a|INFO| wavenumber calibration: True
master.fa09a|INFO| flux calibration: True
master.fa09a|INFO| wcs calibration: True
master.fa09a|INFO| Init of the parallel processing server with 32 threads
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
 [==========] [100%] [completed in 4m33s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
master.fa09a|INFO| Closing parallel processing server
master.fa09a|INFO| reloading cube
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
master.fa09a|INFO| Cube is level 3
master.fa09a|INFO| shape: (2048, 2064, 840)
master.fa09a|INFO| wavenumber calibration: True
master.fa09a|INFO| flux calibration: True
master.fa09a|INFO| wcs calibration: True
master.fa09a|INFO| parallel processing closed
master.fa09a|INFO| Velocity of the first line (km/s): 77.3(2.0)
master.fa09a|INFO| Velocity of the first line (km/s): 75.4(2.0)
master.fa09a|INFO| Velocity of the first line (km/s): 71.3(1.9)
master.fa09a|INFO| Velocity of the first line (km/s): 70.7(2.3)
master.fa09a|INFO| Velocity of the first line (km/s): 71.7(2.8)
master.fa09a|INFO| Velocity of the first line (km/s): 66.7(2.5)
master.fa09a|INFO| Velocity of the first line (km/s): 64.1(2.3)
master.fa09a|INFO| Velocity of the first line (km/s): 58.1(2.3)
master.fa09a|INFO| Velocity of the first line (km/s): 62.6(2.2)
master.fa09a|INFO| Velocity of the first line (km/s): 61.0(2.5)
master.fa09a|INFO| Velocity of the first line (km/s): 74.0(1.8)
master.fa09a|INFO| Velocity of the first line (km/s): 75.5(1.9)
master.fa09a|INFO| Velocity of the first line (km/s): 77.2(2.2)
master.fa09a|INFO| Velocity of the first line (km/s): 72.5(3.1)
master.fa09a|INFO| Velocity of the first line (km/s): 69.7(3.3)
master.fa09a|INFO| Velocity of the first line (km/s): 55.3(2.8)
master.fa09a|INFO| Velocity of the first line (km/s): 65.0(2.9)
master.fa09a|INFO| Velocity of the first line (km/s): 58.9(3.0)
master.fa09a|INFO| Velocity of the first line (km/s): 62.7(2.4)
master.fa09a|INFO| Velocity of the first line (km/s): 60.3(2.3)
master.fa09a|INFO| Velocity of the first line (km/s): 76.4(2.0)
master.fa09a|INFO| Velocity of the first line (km/s): 77.9(2.2)
master.fa09a|INFO| Velocity of the first line (km/s): 73.4(2.6)
master.fa09a|INFO| Velocity of the first line (km/s): 48.3(2.6)
master.fa09a|INFO| Velocity of the first line (km/s): 61.7(2.8)
master.fa09a|INFO| Velocity of the first line (km/s): 78.6(1.9)
master.fa09a|INFO| Velocity of the first line (km/s): 75.4(2.5)
master.fa09a|INFO| Velocity of the first line (km/s): 104.3(3.2)
master.fa09a|INFO| Velocity of the first line (km/s): 65.0(2.7)
master.fa09a|INFO| Velocity of the first line (km/s): 75.6(2.4)
master.fa09a|INFO| Velocity of the first line (km/s): 78.8(2.9)
master.fa09a|INFO| Velocity of the first line (km/s): 65.2(2.4)
master.fa09a|INFO| Velocity of the first line (km/s): 80.8(2.6)
master.fa09a|INFO| Velocity of the first line (km/s): 74.4(3.0)
master.fa09a|INFO| Velocity of the first line (km/s): 69.8(2.3)
master.fa09a|INFO| Velocity of the first line (km/s): 78.5(2.4)
master.fa09a|INFO| Velocity of the first line (km/s): 65.4(2.5)
master.fa09a|INFO| Velocity of the first line (km/s): 65.9(2.2)
master.fa09a|INFO| Velocity of the first line (km/s): 74.6(2.5)
master.fa09a|INFO| Velocity of the first line (km/s): 58.8(2.7)
master.fa09a|INFO| Velocity of the first line (km/s): 67.0(2.2)
master.fa09a|INFO| Velocity of the first line (km/s): 70.6(2.0)
master.fa09a|INFO| Velocity of the first line (km/s): 80.9(2.7)
master.fa09a|INFO| Velocity of the first line (km/s): 80.1(3.5)
master.fa09a|INFO| Velocity of the first line (km/s): 70.8(3.1)
master.fa09a|INFO| Velocity of the first line (km/s): 78.1(2.6)
master.fa09a|INFO| Velocity of the first line (km/s): 70.2(1.8)
master.fa09a|INFO| Velocity of the first line (km/s): 74.5(1.4)
master.fa09a|INFO| Velocity of the first line (km/s): 79.4(2.9)
master.fa09a|INFO| Velocity of the first line (km/s): 79.3(2.7)
master.fa09a|INFO| Velocity of the first line (km/s): 77.5(3.3)
master.fa09a|INFO| Velocity of the first line (km/s): 77.7(3.1)
master.fa09a|INFO| Velocity of the first line (km/s): 76.1(3.5)
master.fa09a|INFO| Velocity of the first line (km/s): 74.7(2.9)
master.fa09a|INFO| Velocity of the first line (km/s): 75.2(2.2)
master.fa09a|INFO| Velocity of the first line (km/s): 75.7(1.7)
master.fa09a|INFO| Velocity of the first line (km/s): 71.6(1.5)
master.fa09a|INFO| Velocity of the first line (km/s): 73.8(1.3)
master.fa09a|INFO| x: [ 186.18181818  186.18181818  186.18181818  186.18181818  186.18181818
  186.18181818  186.18181818  186.18181818  186.18181818  186.18181818
  372.36363636  372.36363636  372.36363636  372.36363636  372.36363636
  372.36363636  372.36363636  372.36363636  372.36363636  372.36363636
  558.54545455  558.54545455  558.54545455  558.54545455  558.54545455
  744.72727273  744.72727273  744.72727273  744.72727273  930.90909091
  930.90909091  930.90909091 1117.09090909 1117.09090909 1117.09090909
 1303.27272727 1303.27272727 1303.27272727 1489.45454545 1489.45454545
 1489.45454545 1489.45454545 1675.63636364 1675.63636364 1675.63636364
 1675.63636364 1675.63636364 1675.63636364 1861.81818182 1861.81818182
 1861.81818182 1861.81818182 1861.81818182 1861.81818182 1861.81818182
 1861.81818182 1861.81818182 1861.81818182]
master.fa09a|INFO| y: [ 187.63636364  375.27272727  562.90909091  750.54545455  938.18181818
 1125.81818182 1313.45454545 1501.09090909 1688.72727273 1876.36363636
  187.63636364  375.27272727  562.90909091  750.54545455  938.18181818
 1125.81818182 1313.45454545 1501.09090909 1688.72727273 1876.36363636
  187.63636364  375.27272727  562.90909091 1688.72727273 1876.36363636
  187.63636364  375.27272727 1688.72727273 1876.36363636  187.63636364
  375.27272727 1876.36363636  187.63636364 1688.72727273 1876.36363636
  187.63636364 1688.72727273 1876.36363636  187.63636364 1501.09090909
 1688.72727273 1876.36363636  187.63636364  375.27272727 1313.45454545
 1501.09090909 1688.72727273 1876.36363636  187.63636364  375.27272727
  562.90909091  750.54545455  938.18181818 1125.81818182 1313.45454545
 1501.09090909 1688.72727273 1876.36363636]
master.fa09a|INFO| v: [ 77.30690122  75.42723292  71.29603104  70.74703947  71.71676527
  66.74086248  64.11377386  58.053346    62.58297622  61.04474574
  74.01054084  75.52157459  77.22636344  72.5418529   69.69014005
  55.32754889  64.99891349  58.9375885   62.70848958  60.32799584
  76.36498222  77.90017749  73.41305969  48.25166759  61.66747683
  78.61262775  75.37893981 104.25308835  65.04902046  75.61380729
  78.84037233  65.16314474  80.77022818  74.38134783  69.81025738
  78.51941433  65.42526138  65.85118873  74.60799346  58.79111662
  66.95923754  70.63770242  80.9106735   80.12792716  70.77220517
  78.1282894   70.221003    74.52473849  79.4390245   79.2954783
  77.52699254  77.7411457   76.13299069  74.74027681  75.16744211
  75.65534916  71.59209525  73.79256937]
<span class="ansi-yellow-fg">master.fa09a|WARNING| /home/thomas/Astro/Python/ORB/Orcs/orcs/utils.py:212: RuntimeWarning: invalid value encountered in greater
  vel[vel &gt; np.nanpercentile(vel, 95)] = np.nan
</span>
master.fa09a|INFO| First laser wavelentgh calibration estimation: 543.3684614763755 nm
master.fa09a|INFO| Angle at the center of the frame: 15.494273258242744
<span class="ansi-yellow-fg">master.fa09a|WARNING| /home/thomas/Astro/Python/ORB/Orb/orb/utils/image.py:1191: RuntimeWarning: invalid value encountered in less
  calib_laser_map[np.nonzero(calib_laser_map &lt; value_min)] = np.nan
</span>
master.fa09a|INFO| &gt; Binning calibration map
<span class="ansi-yellow-fg">master.fa09a|WARNING| /home/thomas/Astro/Python/ORB/Orb/orb/utils/image.py:1074: RuntimeWarning: Mean of empty slice
  return np.squeeze(np.nanmean(np.nanmean(im_view, axis=3), axis=1))
</span>
master.fa09a|INFO| &gt; Calibration laser map fit
master.fa09a|INFO|   &gt; First fit on the central portion of the calibration laser map (30.0% of the total size)
master.fa09a|INFO|     &gt; Calibration laser map fit parameters:
    distance to mirror: 23.681739781375743 cm
    X angle from the optical axis to the center: 0.0 degrees (Fixed)
    Y angle from the optical axis to the center: 15.501669386747308 degrees
    Tip-tilt angle of the detector along X: 0.0 degrees (Fixed)
    Tip-tilt angle of the detector along Y: 0.0 degrees (Fixed)
    Rotation angle of the detector: 0.0 degrees (Fixed)
    Calibration laser wavelength: 543.3684614763755 nm (Fixed)
    Error on fit: mean -1.2212972352744125e-06, std 0.049408481925003994 (in nm)
    Error on fit: mean -0.0006742923017409128, std 27.27899322170293 (in km/s)
master.fa09a|INFO|   &gt; Second fit on the central portion of the calibration laser map (30.0% of the total size)
master.fa09a|INFO|     &gt; Calibration laser map fit parameters:
    distance to mirror: 23.66483634860634 cm
    X angle from the optical axis to the center: -0.44808541110452904 degrees
    Y angle from the optical axis to the center: 15.495141935947101 degrees
    Tip-tilt angle of the detector along X: 0.41142114590561524 degrees
    Tip-tilt angle of the detector along Y: -1.41769820240921 degrees
    Rotation angle of the detector: 0.0 degrees (Fixed)
    Calibration laser wavelength: 543.3684614763755 nm (Fixed)
    Error on fit: mean -3.798378046820534e-07, std 0.0007481455641519504 (in nm)
    Error on fit: mean -0.0002097128366541575, std 0.41305980224865047 (in km/s)
master.fa09a|INFO|   &gt; Third fit on a larger portion of the map (50.0% of the total size)
master.fa09a|INFO|     &gt; Calibration laser map fit parameters:
    distance to mirror: 23.702051086393453 cm
    X angle from the optical axis to the center: -0.44853898242361845 degrees
    Y angle from the optical axis to the center: 15.495504360876263 degrees
    Tip-tilt angle of the detector along X: 0.25839602728725264 degrees
    Tip-tilt angle of the detector along Y: -0.8882041482610137 degrees
    Rotation angle of the detector: 0.0 degrees (Fixed)
    Calibration laser wavelength: 543.3684614763755 nm (Fixed)
    Error on fit: mean -2.4518726781407214e-06, std 0.003041168391745898 (in nm)
    Error on fit: mean -0.0013537072089970703, std 1.6790641750624251 (in km/s)
master.fa09a|INFO|   &gt; Zernike polynomials fit of the residual wavefront
<span class="ansi-yellow-fg">master.fa09a|WARNING| /home/thomas/Astro/Python/ORB/Orb/orb/ext/zern.py:300: FutureWarning: `rcond` parameter will change to the default of machine precision times ``max(M, N)`` where M and N are the input matrix dimensions.
To use the future default and silence this warning we advise to pass `rcond=None`, to keep using the old, explicitly pass `rcond=-1`.
  wf_zern_vec = np.linalg.lstsq((zern_basismat[:, grid_vec] * weight).T, wf_w.ravel())[0]
</span>
master.fa09a|INFO| Standard deviation of the residual: 1.8507972727041484e-05
master.fa09a|INFO| Median relative error (err/val)): 0.05%
master.fa09a|INFO| &gt; final error (std on 50.0% of the total size): 1.763e-05 nm, 9.733e-03 km/s
master.fa09a|INFO|     &gt; New calibration laser map fit parameters:
    distance to mirror: 23.67734145891187 cm
    X angle from the optical axis to the center: 0.1594504146076437 degrees
    Y angle from the optical axis to the center: 15.503103983197793 degrees
    Tip-tilt angle of the detector along X: 4.033689007793616 degrees
    Tip-tilt angle of the detector along Y: -0.3016934072811556 degrees
    Rotation angle of the detector: 2.2124798963045356 degrees
    Calibration laser wavelength: 543.3680110441915 nm

master.fa09a|INFO| fit residual std (in km/s):
master.fa09a|INFO| median error on the data (in km/s)
master.fa09a|INFO| Data written as ./M31_SN3/M31_SN3.calibration_laser_map.fits in 0.33 s
master.fa09a|INFO| Data written as ./M31_SN3/M31_SN3.wavefront_map.fits in 0.23 s
master.fa09a|INFO| Data written as ./M31_SN3/M31_SN3.skymap.fits in 0.26 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/script_example_wavelength_calibration_8_7.png" src="_images/script_example_wavelength_calibration_8_7.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/script_example_wavelength_calibration_8_8.png" src="_images/script_example_wavelength_calibration_8_8.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/script_example_wavelength_calibration_8_9.png" src="_images/script_example_wavelength_calibration_8_9.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/script_example_wavelength_calibration_8_10.png" src="_images/script_example_wavelength_calibration_8_10.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/script_example_wavelength_calibration_8_11.png" src="_images/script_example_wavelength_calibration_8_11.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/script_example_wavelength_calibration_8_12.png" src="_images/script_example_wavelength_calibration_8_12.png" />
</div>
</div>
</div>
<div class="section" id="Ouputs">
<h2>Ouputs<a class="headerlink" href="#Ouputs" title="Permalink to this headline">¶</a></h2>
<p>The most important output is the skymap which gives the modelized velocity of the sky in the field of view and permit to correct the measured velocities in the cube.This map is named <code class="docutils literal notranslate"><span class="pre">*skymap.fits</span></code>. You can add it to the obtained velocity maps to correct the velocity.</p>
<p>In this particular case this is <code class="docutils literal notranslate"><span class="pre">M31_SN3/M31_SN3.skymap.fits</span></code></p>
<p>The histogram above shows the difference between the measured velocity and the fitted velocity at each valid data point.</p>
<p>You can see that there are some data points at the center of the field which were excluded from the fit. This comes from the fact that M31 is very bright at the center and the sky lines are lost in the noise produced by the high continuum background. Modelling the interferometer makes possible to estimate the velocity of the lines at the center of the field where no velocity measurement could be done. And the result is stricking, it works particularly well even if the case of M31 (<a class="reference external" href="https://arxiv.org/abs/1707.01366">Martin et
al. 2017a</a>)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>import orb.utils.io
skymap = orb.utils.io.read_fits(&#39;./M31_SN3/M31_SN3.skymap.fits&#39;)
pl.imshow(skymap.T, origin=&#39;bottom&#39;)
pl.grid()
cb = pl.colorbar()
cb.set_label(&#39;velocity error (km/s)&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/script_example_wavelength_calibration_10_0.png" src="_images/script_example_wavelength_calibration_10_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="script_example_image_registration.html" class="btn btn-neutral float-right" title="Image registration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="script_example_model%2Bfit_2_lines_bayes.html" class="btn btn-neutral float-left" title="Modelling and fitting two unresolved emission lines with a bayesian approach" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2024, Thomas Martin (thomas.martin.1@ulaval.ca).

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>