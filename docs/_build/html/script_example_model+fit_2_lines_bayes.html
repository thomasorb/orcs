

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Modelling and fitting two unresolved emission lines with a bayesian approach &mdash; Orcs latest documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="_static/logo.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Wavelength recalibration with the sky lines (Mendel OH bands)" href="script_example_wavelength_calibration.html" />
    <link rel="prev" title="Modelling and fitting a spectrum with two resolved lines" href="script_example_model%2Bfit_2_lines.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Orcs
          

          
            
            <img src="_static/logo_sidebar.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                lastest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="examples.html#first-basic-examples">First basic examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#automatic-velocity-and-flux-estimation-complete-examples">Automatic velocity and flux estimation (complete examples)</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="examples.html#bayesian-fitting-vs-classical-fitting">Bayesian fitting vs. classical fitting</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="script_example_model%2Bfit_1_line.html">Modelling and fitting a single line spectrum</a></li>
<li class="toctree-l3"><a class="reference internal" href="script_example_model%2Bfit_2_lines.html">Modelling and fitting a spectrum with two resolved lines</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Modelling and fitting two unresolved emission lines with a bayesian approach</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Third-step:-modelling-and-fitting-a-spectrum-with-two-unresolved-lines-(classic-fit-and-bayesian-fit)">Third step: modelling and fitting a spectrum with two unresolved lines (classic fit and bayesian fit)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#calibrating-your-data">Calibrating your data</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#advanced-fitting">Advanced fitting</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#other-tools">Other Tools</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="core_module.html">Core module</a></li>
<li class="toctree-l1"><a class="reference internal" href="fit_module.html">Fit module</a></li>
<li class="toctree-l1"><a class="reference internal" href="process_module.html">Process module</a></li>
<li class="toctree-l1"><a class="reference internal" href="utils_module.html">Utils module</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Orcs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="examples.html">Examples</a> &raquo;</li>
        
      <li>Modelling and fitting two unresolved emission lines with a bayesian approach</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/script_example_model+fit_2_lines_bayes.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Modelling-and-fitting-two-unresolved-emission-lines-with-a-bayesian-approach">
<h1>Modelling and fitting two unresolved emission lines with a bayesian approach<a class="headerlink" href="#Modelling-and-fitting-two-unresolved-emission-lines-with-a-bayesian-approach" title="Permalink to this headline">¶</a></h1>
<p>We will show how to model a spectrum with two superimposed lines and then try to retrieve the modelling parameters. this example is based on the preliminary examples :</p>
<ol class="arabic simple">
<li><p><a class="reference internal" href="script_example_model%2Bfit_1_line.html"><span class="doc">Modelling and fitting one emission line</span></a></p></li>
<li><p><a class="reference internal" href="script_example_model%2Bfit_2_lines.html"><span class="doc">Modelling and fitting two resolved emission lines</span></a></p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">orb.fit</span>
<span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">orb.core</span> <span class="kn">import</span> <span class="n">Lines</span>
</pre></div>
</div>
</div>
<div class="section" id="Third-step:-modelling-and-fitting-a-spectrum-with-two-unresolved-lines-(classic-fit-and-bayesian-fit)">
<h2>Third step: modelling and fitting a spectrum with two unresolved lines (classic fit and bayesian fit)<a class="headerlink" href="#Third-step:-modelling-and-fitting-a-spectrum-with-two-unresolved-lines-(classic-fit-and-bayesian-fit)" title="Permalink to this headline">¶</a></h2>
<p>Now the two lines are set to nearly the same velocity but the other parameters are unchanged.</p>
<div class="section" id="Model">
<h3>Model<a class="headerlink" href="#Model" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">halpha_cm1</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span><span class="o">.</span><span class="n">get_line_cm1</span><span class="p">(</span><span class="s1">&#39;Halpha&#39;</span><span class="p">)</span>

<span class="n">step</span> <span class="o">=</span> <span class="mi">2943</span>
<span class="n">order</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">step_nb</span> <span class="o">=</span> <span class="mi">840</span>
<span class="n">axis_corr</span> <span class="o">=</span> <span class="mf">1.0374712062298759</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">corr2theta</span><span class="p">(</span><span class="n">axis_corr</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;incident angle theta (in degrees):&#39;</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
<span class="n">zpd_index</span> <span class="o">=</span> <span class="mi">168</span>

<span class="c1"># model spectrum</span>
<span class="n">velocity1</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">broadening1</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">spectrum_axis</span><span class="p">,</span> <span class="n">spectrum1</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">create_cm1_lines_model_raw</span><span class="p">([</span><span class="n">halpha_cm1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">step_nb</span><span class="p">,</span> <span class="n">axis_corr</span><span class="p">,</span> <span class="n">zpd_index</span><span class="o">=</span><span class="n">zpd_index</span><span class="p">,</span> <span class="n">fmodel</span><span class="o">=</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">,</span>
                                                                  <span class="n">sigma</span><span class="o">=</span><span class="n">broadening1</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="n">velocity1</span><span class="p">)</span>

<span class="n">velocity2</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">broadening2</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">spectrum_axis</span><span class="p">,</span> <span class="n">spectrum2</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">create_cm1_lines_model_raw</span><span class="p">([</span><span class="n">halpha_cm1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">step_nb</span><span class="p">,</span> <span class="n">axis_corr</span><span class="p">,</span> <span class="n">zpd_index</span><span class="o">=</span><span class="n">zpd_index</span><span class="p">,</span> <span class="n">fmodel</span><span class="o">=</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">,</span>
                                                                  <span class="n">sigma</span><span class="o">=</span><span class="n">broadening2</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="n">velocity2</span><span class="p">)</span>

<span class="n">spectrum</span> <span class="o">=</span> <span class="n">spectrum1</span> <span class="o">+</span> <span class="n">spectrum2</span>

<span class="c1"># add noise</span>
<span class="n">SNR</span> <span class="o">=</span> <span class="mi">22</span>
<span class="n">spectrum</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">SNR</span>

<span class="n">spectrum_axis</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">create_cm1_axis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">),</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="n">axis_corr</span><span class="p">)</span>

<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum_axis</span><span class="p">,</span> <span class="n">spectrum1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;line 1&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum_axis</span><span class="p">,</span> <span class="n">spectrum2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;line 2&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum_axis</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;line1 + line2 + noise&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="mi">15200</span><span class="p">,</span> <span class="mi">15270</span><span class="p">))</span>
<span class="n">pl</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;gvar_model.svg&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
incident angle theta (in degrees): 15.445939567249903
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/script_example_model+fit_2_lines_bayes_4_1.png" src="_images/script_example_model+fit_2_lines_bayes_4_1.png" />
</div>
</div>
</div>
<div class="section" id="Classical-fit">
<h3>Classical fit<a class="headerlink" href="#Classical-fit" title="Permalink to this headline">¶</a></h3>
<p>The classical fit will be be unable to make any difference between an infinity of different possibilities which all gives approximatly the same chi2. the best fit will be very badly constrained and can give random sets of parameters depending on the noise.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">nm_laser</span> <span class="o">=</span> <span class="mf">543.5</span> <span class="c1"># wavelength of the calibration laser, in fact it can be any real positive number (e.g. 1 is ok)</span>
<span class="n">fit</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">fit_lines_in_spectrum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="p">[</span><span class="n">halpha_cm1</span><span class="p">,</span> <span class="n">halpha_cm1</span><span class="p">],</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">nm_laser</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">zpd_index</span><span class="p">,</span>
                                    <span class="n">wavenumber</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">apodization</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fmodel</span><span class="o">=</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">,</span>
                                    <span class="n">pos_def</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">],</span>
                                    <span class="n">pos_cov</span><span class="o">=</span><span class="p">[</span><span class="n">velocity1</span><span class="p">,</span> <span class="n">velocity2</span><span class="p">],</span>
                                    <span class="n">sigma_guess</span><span class="o">=</span><span class="p">[</span><span class="n">broadening1</span><span class="p">,</span> <span class="n">broadening2</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;velocity (in km/s): &#39;</span><span class="p">,</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;velocity_gvar&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;broadening (in km/s): &#39;</span><span class="p">,</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;broadening_gvar&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;flux (in the unit of the spectrum amplitude / unit of the axis fwhm): &#39;</span><span class="p">,</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;flux_gvar&#39;</span><span class="p">])</span>

<span class="c1"># independant plot of the two lines models and the real lines</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum_axis</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;line1 + line2 + noise&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum_axis</span><span class="p">,</span> <span class="n">spectrum1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;line 1&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum_axis</span><span class="p">,</span> <span class="n">spectrum2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;line 2&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">models</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;fitted_models&#39;</span><span class="p">][</span><span class="s1">&#39;Cm1LinesModel&#39;</span><span class="p">]</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum_axis</span><span class="p">,</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;fitted_vector&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;fit&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum_axis</span><span class="p">,</span> <span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;model 1&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum_axis</span><span class="p">,</span> <span class="n">models</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;model 2&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="mi">15200</span><span class="p">,</span> <span class="mi">15270</span><span class="p">))</span>
<span class="n">pl</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="c1"># In fact this &quot;very bad fit&quot; may be not so bad, and will be, in general, not so bad...</span>
<span class="c1"># but its outputs are not constrained as in the bayesian fit and can sometimes be very far from anything realistic</span>
<span class="c1"># if you obtain a good fit, redo the model and the fit multiple times</span>
<span class="n">pl</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;A very bad fit&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;gvar_bad_fit.svg&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING:root:nan in passed parameters: {&#39;amp0&#39;: 1.18644 +- nan, &#39;amp1&#39;: 0.0516463 +- nan, &#39;pos_def1&#39;: 26.9033 +- nan, &#39;pos_def2&#39;: -57.1967 +- nan, &#39;sigma0&#39;: 34.6287 +- nan, &#39;sigma1&#39;: 0.5303 +- nan, &#39;cont_p0&#39;: 0.00261949 +- nan}
WARNING:root:nan in passed parameters: {&#39;amp0&#39;: 1.18644 +- nan, &#39;amp1&#39;: 0.0516463 +- nan, &#39;pos_def1&#39;: 26.9033 +- nan, &#39;pos_def2&#39;: -57.1967 +- nan, &#39;sigma0&#39;: 34.6287 +- nan, &#39;sigma1&#39;: 0.5303 +- nan, &#39;cont_p0&#39;: 0.00261949 +- nan}
WARNING:root:nan in passed parameters: {&#39;amp0&#39;: 1.18644 +- nan, &#39;amp1&#39;: 0.0516463 +- nan, &#39;pos_def1&#39;: 26.9033 +- nan, &#39;pos_def2&#39;: -57.1967 +- nan, &#39;sigma0&#39;: 34.6287 +- nan, &#39;sigma1&#39;: 0.5303 +- nan, &#39;cont_p0&#39;: 0.00261949 +- nan}
WARNING:root:nan in passed parameters: {&#39;amp0&#39;: 1.18644 +- nan, &#39;amp1&#39;: 0.0516463 +- nan, &#39;pos_def1&#39;: 26.9033 +- nan, &#39;pos_def2&#39;: -57.1967 +- nan, &#39;sigma0&#39;: 34.6287 +- nan, &#39;sigma1&#39;: 0.5303 +- nan, &#39;cont_p0&#39;: 0.00261949 +- nan}
WARNING:root:nan in passed parameters: {&#39;amp0&#39;: 1.18644 +- nan, &#39;amp1&#39;: 0.0516463 +- nan, &#39;pos_def1&#39;: 26.9033 +- nan, &#39;pos_def2&#39;: -57.1967 +- nan, &#39;sigma0&#39;: 34.6287 +- nan, &#39;sigma1&#39;: 0.5303 +- nan, &#39;cont_p0&#39;: 0.00261949 +- nan}
WARNING:root:nan in passed parameters: {&#39;amp0&#39;: 1.18644 +- nan, &#39;amp1&#39;: 0.0516463 +- nan, &#39;pos_def1&#39;: 26.9033 +- nan, &#39;pos_def2&#39;: -57.1967 +- nan, &#39;sigma0&#39;: 34.6287 +- nan, &#39;sigma1&#39;: 0.5303 +- nan, &#39;cont_p0&#39;: 0.00261949 +- nan}
WARNING:root:nan in passed parameters: {&#39;amp0&#39;: 1.18644 +- nan, &#39;amp1&#39;: 0.0516463 +- nan, &#39;pos_def1&#39;: 26.9033 +- nan, &#39;pos_def2&#39;: -57.1967 +- nan, &#39;sigma0&#39;: 34.6287 +- nan, &#39;sigma1&#39;: 0.5303 +- nan, &#39;cont_p0&#39;: 0.00261949 +- nan}
WARNING:root:Nan in model
WARNING:root:Nan in model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
velocity (in km/s):  [26.9033 +- nan -57.1967 +- nan]
broadening (in km/s):  [34.6287 +- nan 0.5303 +- nan]
flux (in the unit of the spectrum amplitude / unit of the axis fwhm):  [2.33652 +- nan 0.0583332 +- nan]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/script_example_model+fit_2_lines_bayes_6_2.png" src="_images/script_example_model+fit_2_lines_bayes_6_2.png" />
</div>
</div>
</div>
<div class="section" id="Bayesian-fit">
<h3>Bayesian fit<a class="headerlink" href="#Bayesian-fit" title="Permalink to this headline">¶</a></h3>
<p>Now let’s say you have some informations on the broadening and the velocity of one or both of the unresolved lines e.g. there is some diffused ionized gas in the foreground which is everywhere in the field of view and you are interested into the point-like source emitting in H-alpha at a slightly different velocity.</p>
<p>LSQFIT, a fitting module which integrates gaussian random variable as priors (initial guess) has been developed by G. Peter Lepage (Cornell University) (see <a class="reference external" href="https://github.com/gplepage/lsqfit">https://github.com/gplepage/lsqfit</a> and <a class="reference external" href="http://pythonhosted.org/lsqfit/index.html">http://pythonhosted.org/lsqfit/index.html</a>). This module gives the perfect answer to this problem. We can now inject some more information and help the fitting algorithm to find a unique and better constrained best fit.</p>
<p>This algorithm has been implemented into ORCS. To use it you have to :</p>
<ul class="simple">
<li><p>guess the SNR of the lines (yes, this is not so easy, but you can try with one rough SNR, do the fitting, compute the real SNR from the residual and then fit again, the only thing that will change is the uncertainty on the parameters)</p></li>
<li><p>define the initial guesses as random variables (we will use the package gvar which is intimatly linked to lsqfit - same author)</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">gvar</span> <span class="c1">#  library used to define gaussian random variables</span>
<span class="c1"># now we can define our random variables, we are purposely biasing the inital guess</span>
<span class="c1"># and giving a large error of +/- 10 km/s on both the velocity and the broadening</span>

<span class="n">velocity1_gvar</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">velocity1</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="c1"># velocity1 is known at +/- 10 km/s</span>
<span class="n">velocity2_gvar</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">velocity2</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="c1"># velocity2 is known at +/- 10 km/s</span>
<span class="n">broadening1_gvar</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">broadening1</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="c1"># broadening1 is known at +/- 10 km/s</span>
<span class="n">broadening2_gvar</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">broadening2</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="c1"># broadening2 is known at +/- 10 km/s</span>

<span class="n">fit</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">fit_lines_in_spectrum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="p">[</span><span class="n">halpha_cm1</span><span class="p">,</span> <span class="n">halpha_cm1</span><span class="p">],</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">nm_laser</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">zpd_index</span><span class="p">,</span>
                                    <span class="n">wavenumber</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">apodization</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fmodel</span><span class="o">=</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">,</span>
                                    <span class="n">pos_def</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">],</span>
                                    <span class="n">pos_cov</span><span class="o">=</span><span class="p">[</span><span class="n">velocity1_gvar</span><span class="p">,</span> <span class="n">velocity2_gvar</span><span class="p">],</span>
                                    <span class="n">sigma_def</span><span class="o">=</span><span class="s1">&#39;free&#39;</span><span class="p">,</span>
                                    <span class="n">sigma_guess</span><span class="o">=</span><span class="p">[</span><span class="n">broadening1_gvar</span><span class="p">,</span> <span class="n">broadening2_gvar</span><span class="p">],</span>
                                    <span class="n">snr_guess</span><span class="o">=</span><span class="n">SNR</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== velocity ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;input velocity (km/s): &#39;</span><span class="p">,</span> <span class="n">velocity1_gvar</span><span class="p">,</span> <span class="n">velocity2_gvar</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;fitted velocity (km/s): &#39;</span><span class="p">,</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;velocity_gvar&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;real velocity (km/s)&#39;</span><span class="p">,</span> <span class="n">velocity1</span><span class="p">,</span> <span class="n">velocity2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== broadening ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;input broadening (km/s): &#39;</span><span class="p">,</span> <span class="n">broadening1_gvar</span><span class="p">,</span> <span class="n">broadening2_gvar</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;fitted broadening (km/s): &#39;</span><span class="p">,</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;broadening_gvar&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;real broadening (km/s)&#39;</span><span class="p">,</span> <span class="n">broadening1</span><span class="p">,</span> <span class="n">broadening2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== flux ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;flux (in the unit of the spectrum amplitude / unit of the axis fwhm): &#39;</span><span class="p">,</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;flux_gvar&#39;</span><span class="p">])</span>
<span class="c1"># independant plot of the two lines models and the real lines</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum_axis</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;line1 + line2 + noise&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum_axis</span><span class="p">,</span> <span class="n">spectrum1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;line 1&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum_axis</span><span class="p">,</span> <span class="n">spectrum2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;line 2&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">models</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;fitted_models&#39;</span><span class="p">][</span><span class="s1">&#39;Cm1LinesModel&#39;</span><span class="p">]</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum_axis</span><span class="p">,</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;fitted_vector&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;fit&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum_axis</span><span class="p">,</span> <span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;model 1&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum_axis</span><span class="p">,</span> <span class="n">models</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;model 2&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="mi">15200</span><span class="p">,</span> <span class="mi">15270</span><span class="p">))</span>
<span class="n">pl</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">pl</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;A much better fit&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;gvar_good_fit.svg&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
=== velocity ===
input velocity (km/s):  53(10) 7(10)
fitted velocity (km/s):  [54.8(5.1) 8.5(4.8)]
real velocity (km/s) 50 10
=== broadening ===
input broadening (km/s):  18(10) 27(10)
fitted broadening (km/s):  [18.000(25) 27.000(37)]
real broadening (km/s) 15 30
=== flux ===
flux (in the unit of the spectrum amplitude / unit of the axis fwhm):  [0.81(18) 1.50(18)]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/script_example_model+fit_2_lines_bayes_8_1.png" src="_images/script_example_model+fit_2_lines_bayes_8_1.png" />
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="script_example_wavelength_calibration.html" class="btn btn-neutral float-right" title="Wavelength recalibration with the sky lines (Mendel OH bands)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="script_example_model%2Bfit_2_lines.html" class="btn btn-neutral float-left" title="Modelling and fitting a spectrum with two resolved lines" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2024, Thomas Martin (thomas.martin.1@ulaval.ca).

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>